---
- include_vars : "{{ item }}"
  with_first_found:
    - "../vars/{{ ansible_os_family }}.yml"

- name: install deps
  package:
    name={{ item }}
    state=present
  become: yes
  with_items:
    - bash
    - "{{ python3_package_name }}"
    - "{{ pip3_package_name }}"

- name: set bash as default shell
  user:
    name={{ ansible_env.USER }}
    shell=/bin/bash
  become: yes
  when: ansible_os_family == 'Debian'

- name: set bash as default shell
  replace:
    dest=/etc/passwd
    regexp='(^{{ ansible_user_id }}:.+:.+:.+:.+:.+:).+$'
    replace='\1/bin/bash'
  become: yes
  when: ansible_os_family == 'Alpine' and ansible_user_shell != '/bin/bash'

- name: get installed python3 version
  shell: python3 --version 2>&1
  register: python3_version

- set_fact:
    python3_compatible: "{% if '3.4' in python3_version.stdout or '3.5' in python3_version.stdout %}yes{% else %}no{% endif %}"

- name: install python packages
  pip:
    name={{ item }}
    executable=pip3
    state=latest
  become: yes
  with_items:
    - prompt_toolkit
    - pygments
    - xonsh
    - xonsh-apt_tabcomplete
    - xonsh-autoxsh
    - xonsh-docker_tabcomplete
    - xonsh-vox_tabcomplete
  when: python3_compatible

- name: link files
  file:
    src={{ batcave_path }}/roles/xonsh/files/{{ item.src }}
    dest={{ item.dest }}
    state=link
  with_items:
    - { 'src': 'xonshrc', 'dest': '~/.xonshrc' }
  when: python3_compatible

- name: remove lines from .profile
  lineinfile:
    dest=~/.profile
    state=absent
    line={{ item }}
  with_items:
    - '[ -f /usr/local/bin/xonsh ] && exec /usr/local/bin/xonsh'
    - '[ -f /usr/bin/xonsh ] && exec /usr/bin/xonsh'
  when: python3_compatible

- name: source bashrc in profile
  lineinfile:
    dest=~/.bash_profile
    state=present
    create=yes
    line={{ item }}
  with_items:
    - 'if [ -f ~/.bashrc ]; then'
    - '  . ~/.bashrc'
    - 'fi'
  when: python3_compatible

- name: add lines to .bashrc
  lineinfile:
    dest=~/.bashrc
    state=present
    create=yes
    line={{ item }}
  with_items:
    - '# activate xonsh'
    - '[ -f /usr/local/bin/xonsh ] && exec /usr/local/bin/xonsh -l'
    - '[ -f /usr/bin/xonsh ] && exec /usr/bin/xonsh -l'
  when: python3_compatible
